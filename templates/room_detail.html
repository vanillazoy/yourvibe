<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>{{ room.title }} | YourVibe</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    // ğŸ”¹ AI ì¶”ì²œ ìš”ì²­
    async function getAIRecommendations(roomId) {
      const aiList = document.getElementById("ai-list");
      aiList.innerHTML = "";
      aiList.innerHTML = `<p class="text-gray-400 text-sm">AIê°€ ê³¡ì„ ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤...</p>`;

      try {
        const res = await fetch(`/api/${roomId}/recommend`, {
          method: "POST",
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || "AI ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
          aiList.innerHTML = "";
          return;
        }

        const songs = data.recommended_songs || [];
        if (!songs.length) {
          aiList.innerHTML = `<p class="text-gray-400 text-sm">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ì–´ìš”.</p>`;
          return;
        }

        // ì¶”ì²œ ê²°ê³¼ ì¹´ë“œ ë Œë”ë§
        aiList.innerHTML = "";
        songs.forEach((song) => {
          const card = document.createElement("button");
          card.className =
            "w-full text-left bg-white/5 hover:bg-white/10 transition border border-white/10 rounded-xl px-4 py-3 flex flex-col";
          card.innerHTML = `
            <span class="font-semibold text-sm text-teal-300">${song.title}</span>
            <span class="text-xs text-gray-300">${song.artist}</span>
            ${song.genre ? `<span class="text-[11px] text-gray-400 mt-1">${song.genre}</span>` : ""}
            <span class="text-[11px] text-sky-400 mt-2">í´ë¦­í•˜ë©´ ì´ ë°© í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë©ë‹ˆë‹¤</span>
          `;
          card.addEventListener("click", () => {
            addTrackFromAI(roomId, song.title, song.artist);
          });
          aiList.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        alert("AI ì¶”ì²œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆì–´ìš”.");
        aiList.innerHTML = "";
      }
    }

    // ğŸ”¹ AI ì¶”ì²œ ì¹´ë“œ í´ë¦­ â†’ ê³¡ ì¶”ê°€
    async function addTrackFromAI(roomId, title, artist) {
      if (!confirm(`'${title} - ${artist}' ê³¡ì„ ì´ ë°©ì— ì¶”ê°€í• ê¹Œìš”?`)) return;

      try {
        const res = await fetch(`/api/${roomId}/add`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: title,
            artist: artist,
            moods: [],  // í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— ë¬´ë“œ íƒœê·¸ë„ ê°™ì´ ë³´ë‚¼ ìˆ˜ ìˆìŒ
          }),
        });

        const data = await res.json();
        if (!res.ok || !data.ok) {
          alert(data.error || "ê³¡ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆì–´ìš”.");
          return;
        }

        alert("í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ê³¡ì´ ì¶”ê°€ëì–´ìš”!");
        // ê°„ë‹¨í•˜ê²Œ ìƒˆë¡œê³ ì¹¨í•´ì„œ ëª©ë¡ ê°±ì‹ 
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.");
      }
    }
  </script>
</head>

<body class="bg-[#0f172a] text-white min-h-screen flex flex-col items-center">
  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="flex justify-between items-center w-full max-w-5xl p-6">
    <a href="/rooms" class="text-sky-400 hover:text-teal-300 transition">â† ëŒì•„ê°€ê¸°</a>
    <form action="/room/{{ room_id }}/delete" method="post" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ì–´ìš”?')">
      <button class="text-gray-400 hover:text-red-400 text-sm">ì‚­ì œ</button>
    </form>
  </header>

  <main class="w-full max-w-4xl p-8 text-center space-y-10">
    <!-- ë°© ì •ë³´ ì¹´ë“œ -->
    <section class="bg-white/10 backdrop-blur-lg p-8 rounded-3xl border border-white/10 shadow-xl">
      <img src="{{ room.cover }}" alt="cover" class="w-64 h-64 object-cover rounded-2xl mx-auto mb-6" />
      <h1 class="text-3xl font-bold text-teal-300 mb-2">{{ room.title }}</h1>
      <p class="text-gray-400">{{ room.tag }}</p>
    </section>

    <!-- ê¸°ì¡´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ -->
    <section class="text-left">
      <h2 class="text-xl font-semibold mb-4 text-sky-300">ğŸ¶ í˜„ì¬ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h2>
      {% if room.playlist %}
      <ul class="space-y-3">
        {% for t in room.playlist %}
        <li class="bg-white/5 p-3 rounded-lg border border-white/10 flex justify-between items-center">
          <div>
            <span class="font-medium">{{ t.title }}</span>
            <span class="text-gray-400 text-sm"> - {{ t.artist }}</span>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-gray-500">ê³¡ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢</p>
      {% endif %}
    </section>

    <!-- AI ì¶”ì²œ ì˜ì—­ -->
    <section class="text-left">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-sky-300">ğŸ¤– AI ì¶”ì²œë°›ê¸°</h2>
        <button
          onclick="getAIRecommendations('{{ room_id }}')"
          class="bg-gradient-to-r from-teal-400 to-sky-400 px-4 py-2 rounded-xl text-sm hover:opacity-90 transition-all"
        >
          AIì—ê²Œ ì¶”ì²œ ë°›ê¸°
        </button>
      </div>

      <p class="text-xs text-gray-400 mb-3">
        ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ ë°©ì˜ ê³¡ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ë¹„ìŠ·í•œ ê°ì„±ì˜ ë…¸ë˜ë¥¼ ì¶”ì²œí•´ìš”.<br />
        ì•„ë˜ ì¹´ë“œ í•˜ë‚˜ë¥¼ í´ë¦­í•˜ë©´ ê³¡ì´ ë°”ë¡œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë©ë‹ˆë‹¤.
      </p>

      <div id="ai-list" class="grid gap-3">
        <!-- JSì—ì„œ AI ì¶”ì²œ ì¹´ë“œë“¤ì´ ë“¤ì–´ì˜¤ëŠ” ìë¦¬ -->
      </div>
    </section>
  </main>
</body>
</html>
